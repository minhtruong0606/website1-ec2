name: CI/CD Pipeline - Production
on:
  push:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'

    - name: Validate PHP Syntax
      run: |
        echo "=== CHECKING PHP SYNTAX ==="
        find . -name "*.php" -exec php -l {} \;
        echo "âœ… PHP check completed!"

  deploy-to-production:
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to EC2
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
        SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
      run: |
        echo "ğŸš€ STARTING PRODUCTION DEPLOYMENT..."
        
        # Táº¡o SSH key file
        echo "$SSH_KEY" > private_key.pem
        chmod 600 private_key.pem
        
        # Deploy commands
        ssh -o StrictHostKeyChecking=no -i private_key.pem $EC2_USER@$EC2_HOST "
          echo '=== ğŸ‰ PRODUCTION DEPLOYMENT ==='
          echo 'ğŸ“¦ Pulling latest code...'
          cd /var/www/html
          sudo git fetch origin
          sudo git reset --hard origin/main
          echo 'ğŸ”§ Setting permissions...'
          sudo chown -R ubuntu:ubuntu /var/www/html
          sudo chmod -R 755 /var/www/html
          echo 'ğŸ”„ Restarting web server...'
          sudo systemctl restart apache2
          echo 'âœ… Deployment completed!'
          echo 'ğŸŒ Website: http://$EC2_HOST'
          echo 'ğŸ•’ Deployed at: $(date)'
        "
        
        # Cleanup
        rm -f private_key.pem
        
        echo "ğŸ‰ PRODUCTION DEPLOYMENT SUCCESSFUL!"
        echo "ğŸ“Š Live at: http://$EC2_HOST"
name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    # CÃ¡c step hiá»‡n cÃ³ cho web1...
    
    - name: Configure Web2 in Nginx
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ğŸ”§ Configuring Web2 in Nginx..."
          
          # Táº¡o Nginx config cho web2
          sudo tee /etc/nginx/sites-available/web2 << 'EOF'
          server {
              listen 80;
              server_name _;
              
              root /var/www/html/E-Commerce-1-Website-PHP-MYSQL-main;
              index index.php index.html index.htm;

              location / {
                  try_files $uri $uri/ =404;
              }

              location ~ \.php$ {
                  include snippets/fastcgi-php.conf;
                  fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
                  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                  include fastcgi_params;
              }
          }
          EOF
          
          # KÃ­ch hoáº¡t web2
          sudo ln -sf /etc/nginx/sites-available/web2 /etc/nginx/sites-enabled/
          sudo nginx -t
          sudo systemctl reload nginx
          
          echo "âœ… Web2 configured!"
          echo "ğŸŒ Web1: http://${{ secrets.EC2_HOST }}/"
          echo "ğŸŒ Web2: http://${{ secrets.EC2_HOST }}/E-Commerce-1-Website-PHP-MYSQL-main/"
